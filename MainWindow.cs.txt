using System.Diagnostics;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Input;
using System.Windows.Media;

namespace GridNotes;

public partial class MainWindow : Window
{
    private const string AppName = "GridNotes";

    private AppState _state = new();
    private readonly Debouncer _saveDebounce = new(TimeSpan.FromMilliseconds(500));

    private bool _editLayoutEnabled;
    private bool _isResizing;
    public MainWindow()
    {
        InitializeComponent();

        Loaded += OnLoaded;
        Closing += OnClosing;

        SaveBtn.Click += (_, _) => SaveNow();

        StartWithWindowsCheck.Checked += (_, _) => SetStartup(true);
        StartWithWindowsCheck.Unchecked += (_, _) => SetStartup(false);

        EditLayoutToggle.Checked += (_, _) => { _editLayoutEnabled = true; RenderAll(); SaveSoon(); };
        EditLayoutToggle.Unchecked += (_, _) => { _editLayoutEnabled = false; RenderAll(); SaveSoon(); };

        // CellSize via mouse: Ctrl + rotellina
        //PreviewMouseWheel += OnPreviewMouseWheel;
    }

    private void OnLoaded(object sender, RoutedEventArgs e)
    {
        _state = Storage.Load();

        // se non c'è nulla, crea una griglia 2x2
        if (_state.Tiles.Count == 0)
            CreateDefault2x2();

        bool regEnabled = Startup.IsEnabled(AppName);
        bool shouldEnable = _state.StartWithWindows || regEnabled;
        StartWithWindowsCheck.IsChecked = shouldEnable;
        _state.StartWithWindows = shouldEnable;

        _editLayoutEnabled = false;
        EditLayoutToggle.IsChecked = false;

        // posizionamento su 2° schermo
        WindowPlacer.PlaceOnSecondScreenCenter(this, _state.WindowWidth, _state.WindowHeight);

        RenderAll();
        SaveSoon();
    }

    private int BoardCellsX => Math.Max(1, (int)Math.Floor(Board.ActualWidth / Cell));
private int BoardCellsY => Math.Max(1, (int)Math.Floor(Board.ActualHeight / Cell));

private void ClampMoveToBoard(Tile t)
{
    // mantiene W/H (già validi) e clampa solo posizione
    t.X = Math.Max(0, Math.Min(t.X, BoardCellsX - t.W));
    t.Y = Math.Max(0, Math.Min(t.Y, BoardCellsY - t.H));
}

private void ClampResizeRightToBoard(Tile t)
{
    // ancora a sinistra: NON modificare X, clampa solo W
    t.W = Math.Max(1, Math.Min(t.W, BoardCellsX - t.X));
}

private void ClampResizeBottomToBoard(Tile t)
{
    // ancora in alto: NON modificare Y, clampa solo H
    t.H = Math.Max(1, Math.Min(t.H, BoardCellsY - t.Y));
}

private void ClampResizeBottomRightToBoard(Tile t)
{
    // ancora in alto-sinistra: NON modificare X/Y, clampa W/H
    t.W = Math.Max(1, Math.Min(t.W, BoardCellsX - t.X));
    t.H = Math.Max(1, Math.Min(t.H, BoardCellsY - t.Y));
}

private void OnClosing(object? sender, System.ComponentModel.CancelEventArgs e)
    {
        _state.WindowWidth = (int)Width;
        _state.WindowHeight = (int)Height;
        SaveNow();
    }

    private void OnPreviewMouseWheel(object sender, MouseWheelEventArgs e)
    {
        return; // disabilitato

        if ((Keyboard.Modifiers & ModifierKeys.Control) == 0)
            return;

        // regola CellSize a scatti
        int step = 4;
        int min = 16;
        int max = 128;

        int next = _state.CellSize + (e.Delta > 0 ? step : -step);
        next = Math.Max(min, Math.Min(max, next));

        if (next != _state.CellSize)
        {
            _state.CellSize = next;
            RenderAll();
            SaveSoon();
        }

        e.Handled = true;
    }

    private void SetStartup(bool enabled)
    {
        _state.StartWithWindows = enabled;

        string exe = Process.GetCurrentProcess().MainModule?.FileName ?? "";
        if (!string.IsNullOrWhiteSpace(exe))
            Startup.SetEnabled(AppName, exe, enabled);

        SaveSoon();
    }

    private void SaveSoon() => _saveDebounce.Run(SaveNow);

    private void SaveNow()
    {
        try { Storage.Save(_state); }
        catch { }
    }

    private int Cell => Math.Max(16, _state.CellSize);
    private double ToPx(int cells) => cells * Cell;
    private int SnapToCells(double px) => (int)Math.Round(px / Cell);

    private void CreateDefault2x2()
    {
        // griglia logica: 2x2, ognuno 6x6 celle (puoi cambiare)
        int w = 6;
        int h = 6;

        _state.Tiles.Clear();
        _state.Tiles.Add(new Tile { X = 0,   Y = 0,   W = w, H = h, Text = "" });
        _state.Tiles.Add(new Tile { X = w,   Y = 0,   W = w, H = h, Text = "" });
        _state.Tiles.Add(new Tile { X = 0,   Y = h,   W = w, H = h, Text = "" });
        _state.Tiles.Add(new Tile { X = w,   Y = h,   W = w, H = h, Text = "" });
    }

    private void RenderAll()
    {
        Board.Children.Clear();

        int maxX = 0, maxY = 0;
        foreach (var t in _state.Tiles)
        {
            maxX = Math.Max(maxX, t.X + t.W);
            maxY = Math.Max(maxY, t.Y + t.H);
        }

        foreach (var t in _state.Tiles)
            Board.Children.Add(CreateTileElement(t));
    }

    private FrameworkElement CreateTileElement(Tile t)
    {
        var border = new Border
        {
            Background = new SolidColorBrush(System.Windows.Media.Color.FromRgb(26, 26, 26)),
            BorderBrush = new SolidColorBrush(System.Windows.Media.Color.FromRgb(80, 80, 80)),
            BorderThickness = new Thickness(1),
            CornerRadius = new CornerRadius(0),
            Tag = t
        };

        var grid = new Grid();
        border.Child = grid;

        var tb = new System.Windows.Controls.TextBox
        {
            Text = t.Text,
           Background = System.Windows.Media.Brushes.Transparent,
Foreground = System.Windows.Media.Brushes.White,
            BorderThickness = new Thickness(0),
            AcceptsReturn = true,
            TextWrapping = TextWrapping.Wrap,
            VerticalScrollBarVisibility = ScrollBarVisibility.Auto,
            Padding = new Thickness(10),
            Tag = t
        };

        tb.TextChanged += (_, _) =>
        {
            t.Text = tb.Text;
            SaveSoon();
        };

        grid.Children.Add(tb);

        // Resize handles SOLO se edit layout è ON
        if (_editLayoutEnabled)
        {
            // right edge
            grid.Children.Add(CreateEdgeThumbRight(t, border));
            // bottom edge
            grid.Children.Add(CreateEdgeThumbBottom(t, border));
            // bottom-right corner
            grid.Children.Add(CreateCornerThumb(t, border));
        }

        // Context menu: split 2/4 + reset 2x2
        var menu = new ContextMenu();

        var splitV = new MenuItem { Header = "Split in 2 (verticale)" };
        splitV.Click += (_, _) => Split2(t, vertical: true);
        menu.Items.Add(splitV);

        var splitH = new MenuItem { Header = "Split in 2 (orizzontale)" };
        splitH.Click += (_, _) => Split2(t, vertical: false);
        menu.Items.Add(splitH);

        var split4 = new MenuItem { Header = "Split in 4 (quadranti)" };
        split4.Click += (_, _) => Split4(t);
        menu.Items.Add(split4);

        menu.Items.Add(new Separator());

        var reset = new MenuItem { Header = "Reset griglia 2x2" };
        reset.Click += (_, _) =>
        {
            CreateDefault2x2();
            RenderAll();
            SaveSoon();
        };
        menu.Items.Add(reset);

        border.ContextMenu = menu;

        ApplyTileRect(border, t);
        return border;
    }

    private Thumb CreateEdgeThumbRight(Tile t, FrameworkElement container)
    {
        var thumb = new Thumb
        {
            Width = 8,
           HorizontalAlignment = System.Windows.HorizontalAlignment.Right,
VerticalAlignment = System.Windows.VerticalAlignment.Stretch,
            Cursor = System.Windows.Input.Cursors.SizeWE,
            Opacity = 0.25,
            Tag = t
        };

        thumb.DragDelta += (_, e) =>
        {
            int dW = SnapToCells(e.HorizontalChange);
            if (dW != 0)
            {
                t.W = Math.Max(1, t.W + dW);
                ClampResizeRightToBoard(t);
                ApplyTileRect(container, t);
                SaveSoon();
            }
        };

        thumb.DragStarted += (_, _) => { _isResizing = true; thumb.Opacity = 0.6; };
        thumb.DragCompleted += (_, _) => { _isResizing = false; thumb.Opacity = 0.25; };

        return thumb;
    }

    private Thumb CreateEdgeThumbBottom(Tile t, FrameworkElement container)
    {
        var thumb = new Thumb
        {
            Height = 8,
           HorizontalAlignment = System.Windows.HorizontalAlignment.Stretch,
VerticalAlignment = System.Windows.VerticalAlignment.Bottom,
            Cursor = System.Windows.Input.Cursors.SizeNS,
            Opacity = 0.25,
            Tag = t
        };

        thumb.DragDelta += (_, e) =>
        {
            int dH = SnapToCells(e.VerticalChange);
            if (dH != 0)
            {
                t.H = Math.Max(1, t.H + dH);
                ClampResizeBottomToBoard(t);
                ApplyTileRect(container, t);
                SaveSoon();
            }
        };

        thumb.DragStarted += (_, _) => { _isResizing = true; thumb.Opacity = 0.6; };
        thumb.DragCompleted += (_, _) => { _isResizing = false; thumb.Opacity = 0.25; };

        return thumb;
    }

    private Thumb CreateCornerThumb(Tile t, FrameworkElement container)
    {
        var thumb = new Thumb
        {
            Width = 14,
            Height = 14,
            HorizontalAlignment = System.Windows.HorizontalAlignment.Right,
VerticalAlignment = System.Windows.VerticalAlignment.Bottom,
            Cursor = System.Windows.Input.Cursors.SizeNWSE,
            Margin = new Thickness(0, 0, 6, 6),
            Opacity = 0.6,
            Tag = t
        };

        thumb.Template = BuildThumbTemplate();

        

        thumb.DragStarted += (_, _) => _isResizing = true;
        thumb.DragCompleted += (_, _) => _isResizing = false;
thumb.DragDelta += (_, e) =>
        {
            int dW = SnapToCells(e.HorizontalChange);
            int dH = SnapToCells(e.VerticalChange);

            bool changed = false;
            if (dW != 0) { t.W = Math.Max(1, t.W + dW); changed = true; }
            if (dH != 0) { t.H = Math.Max(1, t.H + dH); changed = true; }

            if (changed)
            {
                ClampResizeBottomRightToBoard(t);
                ApplyTileRect(container, t);
                SaveSoon();
            }
        };

        return thumb;
    }

    private ControlTemplate BuildThumbTemplate()
    {
        var factory = new FrameworkElementFactory(typeof(Border));
        factory.SetValue(Border.BackgroundProperty, new SolidColorBrush(System.Windows.Media.Color.FromRgb(120, 120, 120)));
        factory.SetValue(Border.CornerRadiusProperty, new CornerRadius(4));
        factory.SetValue(Border.OpacityProperty, 0.9);
        return new ControlTemplate(typeof(Thumb)) { VisualTree = factory };
    }

    private void ApplyTileRect(FrameworkElement el, Tile t)
    {
        Canvas.SetLeft(el, ToPx(t.X));
        Canvas.SetTop(el, ToPx(t.Y));
        el.Width = ToPx(t.W);
        el.Height = ToPx(t.H);
    }

    private void Split2(Tile t, bool vertical)
    {
        if (vertical)
        {
            if (t.W < 2) return;

            int w1 = t.W / 2;
            int w2 = t.W - w1;

            var a = new Tile { X = t.X, Y = t.Y, W = w1, H = t.H, Text = t.Text };
            var b = new Tile { X = t.X + w1, Y = t.Y, W = w2, H = t.H, Text = "" };

            ReplaceTile(t, a, b);
            return;
        }
        else
        {
            if (t.H < 2) return;

            int h1 = t.H / 2;
            int h2 = t.H - h1;

            var a = new Tile { X = t.X, Y = t.Y, W = t.W, H = h1, Text = t.Text };
            var b = new Tile { X = t.X, Y = t.Y + h1, W = t.W, H = h2, Text = "" };

            ReplaceTile(t, a, b);
            return;
        }
    }

    private void Split4(Tile t)
    {
        if (t.W < 2 || t.H < 2) return;

        int w1 = t.W / 2;
        int w2 = t.W - w1;
        int h1 = t.H / 2;
        int h2 = t.H - h1;

        var a = new Tile { X = t.X,      Y = t.Y,      W = w1, H = h1, Text = t.Text };
        var b = new Tile { X = t.X + w1, Y = t.Y,      W = w2, H = h1, Text = "" };
        var c = new Tile { X = t.X,      Y = t.Y + h1, W = w1, H = h2, Text = "" };
        var d = new Tile { X = t.X + w1, Y = t.Y + h1, W = w2, H = h2, Text = "" };

        _state.Tiles.RemoveAll(x => x.Id == t.Id);
        _state.Tiles.AddRange(new[] { a, b, c, d });

        RenderAll();
        SaveSoon();
    }

    private void ReplaceTile(Tile oldTile, params Tile[] newTiles)
    {
        _state.Tiles.RemoveAll(x => x.Id == oldTile.Id);
        _state.Tiles.AddRange(newTiles);
        RenderAll();
        SaveSoon();
    }
}